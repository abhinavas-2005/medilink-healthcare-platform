{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Scan QR Code from Patient</h2>

    <div id="reader" style="width: 300px;"></div>
    <div id="qr-result" class="mt-3"></div>

    <form id="scan-form" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="qr_token" id="qr_token">
    </form>

    {% comment %} {% if records %}
    <h4 class="mt-4">Accessible Treatment Records:</h4>
    <ul class="list-group mt-3">
        {% for record in records %}
            <li class="list-group-item">
                <strong>Description:</strong> {{ record.description }}<br>
                <a href="{{ record.document.url }}" target="_blank" class="btn btn-sm btn-success mt-2">ðŸ“„ View Document</a><br>
                <small>Uploaded on: {{ record.created_at }}</small>
            </li>
        {% endfor %}
    </ul>
{% elif records is not none %}
    <p class="mt-4 text-danger">Access denied or no visible records.</p>
{% endif %} {% endcomment %}
{% if records %}
    <h4 class="mt-4">Treatment Records:</h4>
    <ul class="list-group mt-3">
        {% for record in records %}
            <li class="list-group-item">
                <strong>Uploaded At:</strong> {{ record.uploaded_at }}<br>
                <a href="{{ record.document.url }}" class="btn btn-sm btn-success" target="_blank">ðŸ“„ View File</a>
            </li>
        {% endfor %}
    </ul>
{% endif %}

{% if access_denied %}
    <div class="alert alert-danger mt-4">
        ðŸš« Access Denied. You are not allowed to view this patient's treatment records.
    </div>
{% endif %}

{% if records %}
    <h3 class="mt-4">Patient Treatment Records</h3>
    <ul class="list-group">
        {% for record in records %}
            <li class="list-group-item">
                {{ record.file.name }} â€” {{ record.uploaded_at }}
            </li>
        {% endfor %}
    </ul>
{% endif %}



</div>

<!-- Include html5-qrcode via CDN -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    function onScanSuccess(decodedText, decodedResult) {
        // Show result and auto-submit
        document.getElementById("qr_token").value = decodedText;
        document.getElementById("scan-form").submit();
    }

    function onScanFailure(error) {
        // optional: console.log(`QR scan failed: ${error}`);
    }

    const html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 10, qrbox: 250 }
    );

    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}
